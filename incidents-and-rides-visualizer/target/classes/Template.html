<!doctype html>
<html>
 <head> 
  <title>SimRa Aachen Rides</title> 
  <meta charset="utf-8" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.0.3/dist/leaflet.css"> 
  <script src="https://unpkg.com/leaflet@1.0.3/dist/leaflet.js"></script> 
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.0/jquery.min.js"></script> 
  <style>
	img.huechange { filter: hue-rotate(120deg); }
   body {
        padding: 0;
        margin: 0;
    }
    html, body, #map {
        height: 100%;
        width: 100%;
    }
</style> 
 </head> 
 <body> 
  <div id="map"></div>  
  <script>
  
const ridesUrl = null;

const map = L.map('map').setView([50.77, 6.08], 12);

map.on('click', function(e) {
	rideLayer.addTo(map);
	incidentLayer.addTo(map);
	if (specificRideLayer !== null) {
		map.removeLayer(specificRideLayer);
	}
	if (specificIncidentsLayer != null) {
		map.removeLayer(specificIncidentsLayer);
	}
});

const osm = new L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
    attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
}).addTo(map);


const normal_style = {
    'weight': 3,
    'opacity': 0.6,
    color: '#000000'
};
const highlight_style = {
    'weight': 6,
    'opacity': 1,
    color: '#0000ff'
};

// Set style function that sets fill color property
function style(feature) {
    return {
	'weight': 3,
	'opacity': 0.6,
	color: '#000000'
    };
}

function onEachRideFeature(feature, layer) {
    const popupContent = "<p><b>ride: </b>" + feature.properties.ride + '</p>';

    layer.bindPopup(popupContent);
	layer.on('mouseover', function () {
		if (typeof layer.setStyle === 'function')
			this.setStyle(highlight_style);
	});
	layer.on('mouseout', function () {
		if (typeof layer.setStyle === 'function')
			this.setStyle(normal_style);
	});
	layer.on('click', function () {
		if (selectedRideID === feature.properties.ride) {
			return
		}
		map.removeLayer(rideLayer);
		map.removeLayer(incidentLayer);
		if (specificRideLayer !== null) {
			map.removeLayer(specificRideLayer);
		}
		if (specificIncidentsLayer != null) {
			map.removeLayer(specificIncidentsLayer);
		}
		selectedRideID = feature.properties.ride;
		specificRideLayer = L.geoJson(ridesUrl, {filter: function(feature, layer) {
            if (feature.geometry.type === "LineString" && selectedRideID === feature.properties.ride) {
                return true;
            }
        }
		,onEachFeature: onEachRideFeature,
		style: style});
		specificRideLayer.addTo(map);
		specificIncidentsLayer = L.geoJson(ridesUrl, {filter: function(feature, layer) {
            if (feature.geometry.type === "Point" && selectedRideID === feature.properties.ride) {
                return true;
            }
        },
		onEachFeature: onEachIncidentFeature,
		pointToLayer(feature, latlng) {
			return getMarker(feature, latlng)
		}});
		specificIncidentsLayer.addTo(map);
	});
	
}

function onEachIncidentFeature (feature, layer) {
	var popupContent = '<p><b>Datum: </b>' + feature.properties.date
	+ '<br /> <b>Fahrradtyp: </b>' + feature.properties.bikeType
	+ '<br /> <b>Kind transportiert: </b>' + feature.properties.child
	+ '<br /> <b>Anhänger dabei: </b>' + feature.properties.trailer
	+ '<br /> <b>Handyort: </b>' + feature.properties.pLoc
	+ '<br /> <b>Gefahrensituation: </b>' + feature.properties.incident
	+ '<br /> <b>Beteiligte Verkehrsteilnehmer: </b>' + feature.properties.participant
	+ '<br /> <b>Diese Erfahrung war beängstigend: </b>' + feature.properties.scary
	+ '<br /> <b>Beschreibung: </b>' + feature.properties.descr
	+ '<br /> <b>Region: </b>' + feature.properties.region
	+ '</p>';

	
	layer.on('click', function () {
		if (selectedRideID === feature.properties.ride) {
			return
		}
		map.removeLayer(rideLayer);
		map.removeLayer(incidentLayer);
		if (specificRideLayer !== null) {
			map.removeLayer(specificRideLayer);
		}
		if (specificIncidentsLayer != null) {
			map.removeLayer(specificIncidentsLayer);
		}
		selectedRideID = feature.properties.ride;
		specificRideLayer = L.geoJson(ridesUrl, {filter: function(feature, layer) {
            if (feature.geometry.type === "LineString" && selectedRideID === feature.properties.ride) {
                return true;
            }
        }
		,onEachFeature: onEachRideFeature,
		style: style});
		specificRideLayer.addTo(map);
		specificIncidentsLayer = L.geoJson(ridesUrl, {filter: function(feature, layer) {
            if (feature.geometry.type === "Point" && selectedRideID === feature.properties.ride) {
                return true;
            }
        },
		onEachFeature: onEachIncidentFeature,
		pointToLayer(feature, latlng) {
			return getMarker(feature, latlng)
		}});
		specificIncidentsLayer.addTo(map);
		layer.openPopup();
		openPopupOfMarker(feature,layer);
	});
	layer.bindPopup(popupContent);

}

function openPopupOfMarker(feature,layer) {
	console.log("layer._latlng:",layer._latlng)
	var newLatLng = {
		lat:(layer._latlng.lat + 0.001),
		lng: layer._latlng.lng
	}
	console.log("newLatLng:",newLatLng)
	layer._latlng.lat = (layer._latlng.lat + 0.001)
	L.popup()
    .setLatLng(newLatLng)
    .setContent(layer._popup._content)
    .openOn(map);
}

function ridesFilter(feature, layer) {
	return (feature.geometry.type === "LineString");
}

function incidentsFilter(feature, layer) {
	return (feature.geometry.type === "Point");
}
	
var specificRideLayer = null;
var specificIncidentsLayer = null;
var selectedRideID = null;
// Null variable that will hold layer
var rideLayer = L.geoJson(ridesUrl, {filter: ridesFilter, onEachFeature: onEachRideFeature, style: style});

rideLayer.addTo(map);

const scaryIncidentMarkerIcon = L.icon({
                iconUrl: './redmarker.png',
                iconSize: [25, 41],
                iconAnchor: [12, 41],
                popupAnchor: [1, -34],
                shadowSize: [41, 41]
            });
			
const incidentMarkerIcon = L.icon({
                iconUrl: './bluemarker.png',
                iconSize: [25, 41],
                iconAnchor: [12, 41],
                popupAnchor: [1, -34],
                shadowSize: [41, 41]
            });

var incidentLayer = L.geoJson(ridesUrl, {filter: incidentsFilter,
	pointToLayer(feature, latlng) {
		return getMarker(feature, latlng)
	},
	onEachFeature: onEachIncidentFeature});

function getMarker(feature, latlng) {
	var marker = L.marker(latlng, {icon: incidentMarkerIcon});
	if (feature.properties.scary === "Ja") {
		marker = L.marker(latlng, {icon: scaryIncidentMarkerIcon});
	}
	return marker;
}
incidentLayer.addTo(map);

// for Layer Control	
var baseMaps = {
    "Open Street Map": osm  	
};

var overlayMaps = {
    "Rides":rideLayer,
	"Incidents":incidentLayer
};	

	
//Add layer control
L.control.layers(baseMaps, overlayMaps).addTo(map);

</script>  
 </body>
</html>